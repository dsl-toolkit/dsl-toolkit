# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2

environment:
  BASH_ENV: "~/.bashrc"

references:
  common: &common
    environment:
      BASH_ENV: "~/.bashrc"
    steps: &steps
      - checkout
      - run: apt-get update && apt-get -y install expect
      - run: expect -c "spawn ssh-add - <<< "${SSH_KEY}" expect -re \"Enter passphrase for (stdin):\"; send \"n\";"
      - run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      - run: git config --global user.email "tothimre@gmail.com" && git config --global user.name "Imre Toth"
      - run: ./bin/node-modules-cache-key.js > ./npm-minor-hash
      - restore_cache:
          keys:
            - deps-{{ checksum "npm-minor-hash" }}
      - run: ls -lah
      - run: ./bin/install.sh
      - run: npm run test                                                                                                                       
      - save_cache:
          key: deps-{{ checksum "npm-minor-hash" }}
          paths:
            #beginning package template
            - packages/cowlog/node_modules
            - packages/directory-fixture-provider/node_modules
            - packages/dsl-framework/node_modules
            - packages/dsl-framework/examples/auto-publish/parenting/node_modules
            - packages/generic-text-linker/node_modules
            - packages/refresh-me/node_modules
            - packages/require-a-lot/node_modules
            - node_modules
            #end package template
  #somehow redundant pieces shall be referenced.
  common_steps_upload: &common_steps_upload
    environment:
      BASH_ENV: "~/.bashrc"
    steps:
      - checkout
      - run: apt-get update && apt-get -y install expect
      - run: expect -c "spawn ssh-add - <<< "${SSH_KEY}" expect -re \"Enter passphrase for (stdin):\"; send \"n\";"
      - run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      - run: git config --global user.email "tothimre@gmail.com" && git config --global user.name "Imre Toth"
      - run: ./bin/node-modules-cache-key.js > ./npm-hash
      - restore_cache:
          keys:
            - deps-{{ checksum "npm-hash" }}
      - run: ls -lah
      - run: ./bin/install.sh
      - run: npm run test                                                                                                                        
      - save_cache:
          key: deps-{{ checksum "npm-hash" }}
          paths:
            #beginning package template
            - packages/cowlog/node_modules
            - packages/directory-fixture-provider/node_modules
            - packages/dsl-framework/node_modules
            - packages/dsl-framework/examples/auto-publish/parenting/node_modules
            - packages/generic-text-linker/node_modules
            - packages/refresh-me/node_modules
            - packages/require-a-lot/node_modules
            - node_modules
            #end package template
      - store_artifacts:
          path: coverage
          destination: prefix
      - store_test_results:
          path: coverage/lcov-report/
     - run:
          name: Setup Code Climate test-reporter
          command: |
          # download test reporter as a static binary
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter
            
      - run: ./cc-test-reporter after-build --coverage-input-type lcov --exit-code $? ./coverage/lcov.info
      # - run: node_modules/codeclimate-test-reporter/bin/codeclimate.js < ./coverage/lcov.info && echo 1 > /tmp/coverage
      - run: bin/github.js


jobs:
  node12:
    docker:
      - image: node:12
    <<: [ *common ]
  node14:
    docker:
      - image: node:14
    <<: [ *common ]
  node16:
    docker:
      - image: node:16
    <<: [ *common ]

workflows:
  version: 2
  build:
    jobs:
      - node14
      # - node16
